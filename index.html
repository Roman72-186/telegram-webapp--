<!-- index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />

  <!-- MAX Mini App Meta Tags -->
  <meta name="theme-color" content="#3390ec" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <title>MAX Mini App - Регистрация</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- IMask -->
  <script src="https://cdn.jsdelivr.net/npm/imask@7.1.3/dist/imask.min.js"></script>

  <!-- MAX Bridge SDK (Updated URL according to documentation) -->
  <script src="https://st.max.ru/js/max-web-app.js"></script>

  <style>
    :root{
      --max-theme-bg-color:#ffffff;
      --max-theme-text-color:#000000;
      --max-theme-hint-color:#999999;
      --max-theme-link-color:#3390ec;
      --max-theme-button-color:#3390ec;
      --max-theme-button-text-color:#ffffff;
      --max-theme-secondary-bg-color:#f1f1f1;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:var(--max-theme-bg-color);
      color:var(--max-theme-text-color);
    }
    .max-button{
      background:var(--max-theme-button-color);
      color:var(--max-theme-button-text-color);
      cursor:pointer;
      pointer-events:auto;
    }
    .max-button:hover{ opacity:.9; }
    .max-button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .max-input{
      border:1px solid #e0e0e0;
      transition:all .2s;
    }
    .max-input:focus{
      border-color:var(--max-theme-button-color);
      outline:none;
      box-shadow:0 0 0 3px rgba(51,144,236,.1);
    }
    .max-input.error{ border-color:#ff3333; }
    .error-message{
      color:#ff3333;
      font-size:.875rem;
      margin-top:.25rem;
      min-height:1.1em;
    }
    .success-message{ display:none; }
    .success-message.show{ display:block; }
    html{ scroll-behavior:smooth; }
    .checkbox-wrapper{
      position:relative;
      display:flex;
      align-items:flex-start;
      gap:.75rem;
    }
    .checkbox-wrapper input[type="checkbox"]{
      width:1.25rem;
      height:1.25rem;
      margin-top:.125rem;
      cursor:pointer;
      accent-color:var(--max-theme-button-color);
    }
    .checkbox-wrapper label{ cursor:pointer; line-height:1.5; }
    .checkbox-wrapper a{
      color:var(--max-theme-link-color);
      text-decoration:underline;
    }
    .checkbox-wrapper a:hover{ opacity:.8; }

    /* Ошибка отправки */
    .fatal-box{
      display:none;
      border:1px solid #ff3333;
      background:#fff5f5;
      border-radius:12px;
      padding:12px 14px;
      margin-top:14px;
      color:#b30000;
      font-size:.95rem;
    }
    .fatal-box.show{ display:block; }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow-sm py-6 px-4">
    <div class="max-w-2xl mx-auto">
      <h1 class="text-3xl font-bold text-gray-900 text-center mb-2">Добро пожаловать!</h1>
      <p class="text-gray-600 text-center">Заполните форму регистрации для доступа к нашему сервису</p>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1 max-w-2xl mx-auto w-full px-4 py-8">
    <!-- Form -->
    <div id="registrationForm" class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
      <form id="form" class="space-y-6" novalidate>
        <!-- First Name -->
        <div>
          <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">
            Имя <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="firstName"
            name="firstName"
            class="max-input w-full px-4 py-3 rounded-lg text-gray-900 placeholder-gray-400"
            placeholder="Введите ваше имя"
            autocomplete="given-name"
          />
          <div id="firstNameError" class="error-message"></div>
        </div>

        <!-- Last Name -->
        <div>
          <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">
            Фамилия <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="lastName"
            name="lastName"
            class="max-input w-full px-4 py-3 rounded-lg text-gray-900 placeholder-gray-400"
            placeholder="Введите вашу фамилию"
            autocomplete="family-name"
          />
          <div id="lastNameError" class="error-message"></div>
        </div>

        <!-- Phone -->
        <div>
          <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
            Номер телефона <span class="text-red-500">*</span>
          </label>
          <input
            type="tel"
            id="phone"
            name="phone"
            class="max-input w-full px-4 py-3 rounded-lg text-gray-900 placeholder-gray-400"
            placeholder="+7 (999) 999-99-99"
            autocomplete="tel"
            inputmode="tel"
          />
          <div id="phoneError" class="error-message"></div>
        </div>

        <!-- Checkboxes -->
        <div class="space-y-4 pt-2">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="agreement1" name="agreement1" class="flex-shrink-0" />
            <label for="agreement1" class="text-sm text-gray-700">
              Я согласен с <a href="offer.html">Офертой</a>
            </label>
          </div>
          <div id="agreement1Error" class="error-message ml-7"></div>

          <div class="checkbox-wrapper">
            <input type="checkbox" id="agreement2" name="agreement2" class="flex-shrink-0" />
            <label for="agreement2" class="text-sm text-gray-700">
              Я согласен с <a href="privacy.html">Политикой конфиденциальности</a>
            </label>
          </div>
          <div id="agreement2Error" class="error-message ml-7"></div>

          <div class="checkbox-wrapper">
            <input type="checkbox" id="agreement3" name="agreement3" class="flex-shrink-0" />
            <label for="agreement3" class="text-sm text-gray-700">
              Я согласен с <a href="data-processing.html">Обработкой персональных данных</a>
            </label>
          </div>
          <div id="agreement3Error" class="error-message ml-7"></div>
        </div>

        <!-- Submit -->
        <button
          type="submit"
          id="submitBtn"
          class="max-button w-full py-4 px-6 rounded-lg font-semibold text-lg transition-all duration-200 shadow-md hover:shadow-lg"
        >
          Отправить
        </button>

        <!-- Loading -->
        <div id="loadingIndicator" class="hidden text-center py-4">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
          <p class="mt-2 text-gray-600">Отправка данных...</p>
        </div>

        <!-- Fatal -->
        <div id="fatalBox" class="fatal-box"></div>
      </form>
    </div>

    <!-- Success -->
    <div id="successMessage" class="success-message bg-green-50 border border-green-200 rounded-2xl p-8 text-center mt-6">
      <div class="text-green-600 text-5xl mb-4">✓</div>
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Спасибо!</h2>
      <p class="text-gray-700 text-lg">Ваше согласие и данные успешно получены</p>
    </div>
  </main>

  <!-- Footer -->
  <footer id="footer" class="bg-gray-50 border-t border-gray-200 mt-auto">
    <div class="max-w-4xl mx-auto px-4 py-6 text-center text-sm text-gray-500">
      <p>&copy; 2025 Все права защищены</p>
    </div>
  </footer>

  <script>
    // ===== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ =====
    let userData = null;
    let isMaxApp = false;
    let maxApi = null;
    let isWebApp = false;
    // ===== DOM =====
    const form = document.getElementById('form');
    const registrationForm = document.getElementById('registrationForm');
    const successMessage = document.getElementById('successMessage');
    const submitBtn = document.getElementById('submitBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const fatalBox = document.getElementById('fatalBox');

    const firstNameInput = document.getElementById('firstName');
    const lastNameInput  = document.getElementById('lastName');
    const phoneInput     = document.getElementById('phone');

    const agreement1 = document.getElementById('agreement1');
    const agreement2 = document.getElementById('agreement2');
    const agreement3 = document.getElementById('agreement3');

    const firstNameError = document.getElementById('firstNameError');
    const lastNameError  = document.getElementById('lastNameError');
    const phoneError     = document.getElementById('phoneError');

    const agreement1Error = document.getElementById('agreement1Error');
    const agreement2Error = document.getElementById('agreement2Error');
    const agreement3Error = document.getElementById('agreement3Error');

    // ===== Phone mask =====
    const phoneMask = IMask(phoneInput, {
      mask: '+{7} (000) 000-00-00',
      lazy: false
    });

    // ===== MAX BRIDGE ИНИЦИАЛИЗАЦИЯ =====
    async function initMaxBridge() {
      console.log('[INIT] MAX init start');

      maxApi = window.WebApp || window.MaxBridge || null;
      isWebApp = !!window.WebApp;

      if (!maxApi) {
        console.warn('[INIT] SDK not available - browser mode');
        isMaxApp = false;
        initBrowserMode();
        return;
      }

      try {
        if (isWebApp) {
          if (maxApi.ready) maxApi.ready();
        } else {
          await maxApi.ready();
          await maxApi.send('WebApp.ready');
        }

        isMaxApp = true;

        await getUserData();

        console.log('[INIT] MAX init done');

      } catch (error) {
        console.error('[INIT] MAX init error:', error);
        isMaxApp = false;
        initBrowserMode();
      }
    }


    // ===== ПОЛУЧЕНИЕ ДАННЫХ ПОЛЬЗОВАТЕЛЯ =====
    async function getUserData() {
      try {
        if (isWebApp) {
          if (maxApi.getUserData) {
            userData = await maxApi.getUserData();
          } else if (maxApi.initDataUnsafe && maxApi.initDataUnsafe.user) {
            userData = maxApi.initDataUnsafe.user;
          } else {
            userData = null;
          }
        } else {
          userData = await maxApi.send('getUserData');
        }

        if (userData && userData.user) userData = userData.user;
        console.log('[USER] userData:', userData);

        if (userData) {
          if (userData.first_name && !firstNameInput.value) {
            firstNameInput.value = userData.first_name;
          }
          if (userData.last_name && !lastNameInput.value) {
            lastNameInput.value = userData.last_name;
          }
        }

      } catch (error) {
        console.error('[USER] getUserData error:', error);
      }
    }


    // ===== РЕЖИМ БРАУЗЕРА (FALLBACK) =====
    function initBrowserMode() {
      console.log('[BROWSER] Инициализация режима браузера');

      const devId = window.DEV_USER_ID || null;
      userData = {
        user_id: devId,
        id: devId,
        name: 'Тестовый пользователь'
      };
    }

    // ===== ЗАКРЫТИЕ ПРИЛОЖЕНИЯ =====
    async function closeApp() {
      if (!isMaxApp) return;

      try {
        if (isWebApp && maxApi.close) {
          maxApi.close();
        } else {
          await maxApi.send('WebApp.close');
        }
      } catch (error) {
        console.error('[CLOSE] close error:', error);
      }
    }


    // ===== Helpers =====
    function showFatal(message) {
      fatalBox.textContent = message || 'Ошибка';
      fatalBox.classList.add('show');
    }
    function hideFatal() {
      fatalBox.textContent = '';
      fatalBox.classList.remove('show');
    }

    function showError(input, errorEl, message) {
      input.classList.add('error');
      errorEl.textContent = message || '';
    }
    function hideError(input, errorEl) {
      input.classList.remove('error');
      errorEl.textContent = '';
    }

    function validateFirstName() {
      const v = (firstNameInput.value || '').trim();
      if (!v) { showError(firstNameInput, firstNameError, 'Поле "Имя" обязательно для заполнения'); return false; }
      if (v.length < 2) { showError(firstNameInput, firstNameError, 'Имя должно содержать минимум 2 символа'); return false; }
      hideError(firstNameInput, firstNameError);
      return true;
    }

    function validateLastName() {
      const v = (lastNameInput.value || '').trim();
      if (!v) { showError(lastNameInput, lastNameError, 'Поле "Фамилия" обязательно для заполнения'); return false; }
      if (v.length < 2) { showError(lastNameInput, lastNameError, 'Фамилия должна содержать минимум 2 символа'); return false; }
      hideError(lastNameInput, lastNameError);
      return true;
    }

    function validatePhone() {
      const digits = (phoneMask.unmaskedValue || '').replace(/\D/g,'');
      const isOk = /^7\d{10}$/.test(digits);
      if (!isOk) { showError(phoneInput, phoneError, 'Введите корректный номер телефона'); return false; }
      hideError(phoneInput, phoneError);
      return true;
    }

    function validateCheckboxes() {
      let ok = true;

      if (!agreement1.checked) { agreement1Error.textContent = 'Необходимо согласие с Офертой'; ok = false; }
      else agreement1Error.textContent = '';

      if (!agreement2.checked) { agreement2Error.textContent = 'Необходимо согласие с Политикой конфиденциальности'; ok = false; }
      else agreement2Error.textContent = '';

      if (!agreement3.checked) { agreement3Error.textContent = 'Необходимо согласие с Обработкой персональных данных'; ok = false; }
      else agreement3Error.textContent = '';

      return ok;
    }

    function buildPhoneE164() {
      const digits = (phoneMask.unmaskedValue || '').replace(/\D/g,'');
      if (!/^7\d{10}$/.test(digits)) return null;
      return `+${digits}`;
    }

    // ===== Real-time validation =====
    firstNameInput.addEventListener('blur', validateFirstName);
    lastNameInput.addEventListener('blur', validateLastName);
    phoneInput.addEventListener('blur', validatePhone);

    agreement1.addEventListener('change', () => { if (agreement1.checked) agreement1Error.textContent = ''; });
    agreement2.addEventListener('change', () => { if (agreement2.checked) agreement2Error.textContent = ''; });
    agreement3.addEventListener('change', () => { if (agreement3.checked) agreement3Error.textContent = ''; });

    // ===== Submit =====
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideFatal();

      const ok =
        (validateFirstName() ? 1 : 0) &
        (validateLastName()  ? 1 : 0) &
        (validatePhone()     ? 1 : 0) &
        (validateCheckboxes()? 1 : 0);

      if (!ok) return;

      const phoneE164 = buildPhoneE164();
      if (!phoneE164) {
        showError(phoneInput, phoneError, 'Введите корректный номер телефона');
        return;
      }

      // Формируем user_id из MAX данных
      const max_user_id = userData?.user_id ?? userData?.id ?? userData?.userId ?? null;
      const payload = {
        firstName: (firstNameInput.value || '').trim(),
        lastName: (lastNameInput.value || '').trim(),
        phone: phoneE164,
        max_user_id: max_user_id,
        telegram_id: max_user_id, // Используем user_id из MAX (совместимость с API)
        telegram: {
          initData: '',
          user: userData || null
        }
      };

      submitBtn.disabled = true;
      loadingIndicator.classList.remove('hidden');

      try {
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const t = await res.text().catch(() => '');
          throw new Error(t || `HTTP ${res.status}`);
        }

        registrationForm.classList.add('hidden');
        successMessage.classList.add('show');

        // Закрываем приложение через 2 секунды после успеха
        setTimeout(async () => {
          await closeApp();
        }, 2000);

      } catch (err) {
        showFatal(`Произошла ошибка при отправке данных: ${err && err.message ? err.message : 'неизвестная ошибка'}`);
      } finally {
        submitBtn.disabled = false;
        loadingIndicator.classList.add('hidden');
      }
    });

    // ===== ЗАПУСК ПРИЛОЖЕНИЯ =====
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('[APP] Страница загружена, начинаем инициализацию');
      await initMaxBridge();
      console.log('[APP] Приложение готово к работе');
    });

    // ===== ОБРАБОТКА ОШИБОК =====
    window.addEventListener('error', (event) => {
      console.error('[ERROR] Глобальная ошибка:', event.error);
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('[ERROR] Необработанный Promise:', event.reason);
    });
  </script>
</body>
</html>
